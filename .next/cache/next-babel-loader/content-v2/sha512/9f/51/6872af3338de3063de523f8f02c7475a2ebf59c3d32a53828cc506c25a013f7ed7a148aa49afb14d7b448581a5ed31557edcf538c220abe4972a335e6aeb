{"ast":null,"code":"function _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\nconst request = require('request');\n\nconst {\n  ObjectID\n} = require('mongodb');\n\nconst {\n  loginMongo\n} = require('../../models/mongo');\n\nconst jwt = require('jsonwebtoken');\n\nconst formidable = require('formidable');\n\nexport const config = {\n  api: {\n    bodyParser: false\n  }\n};\n\nconst upload = async (_id, path, buffer) => {\n  let {\n    db,\n    client\n  } = await loginMongo(process.env.MONGODB, 'users');\n  let {\n    dropboxToken\n  } = await db.findOne({\n    _id: new ObjectID(_id)\n  }, {\n    projection: {\n      _id: 0,\n      dropboxToken: 1\n    }\n  });\n  client.close();\n  return new Promise((s, r) => {\n    request.post({\n      uri: \"https://content.dropboxapi.com/2/files/upload\",\n      headers: {\n        \"Content-Type\": \"application/octet-stream\",\n        \"Authorization\": `Bearer ${dropboxToken}`,\n        \"Dropbox-API-Arg\": JSON.stringify({\n          path,\n          mode: \"add\",\n          autorename: true,\n          mute: false,\n          strict_conflict: false\n        })\n      },\n      body: buffer\n    }, (err, res, body) => {\n      if (err) {\n        r(err);\n      } else {\n        s(body);\n      }\n    });\n  });\n};\n\nconst getBuffer = req => {\n  const form = new formidable.IncomingForm();\n  return new Promise((s, r) => {\n    form.on('data', (_ref) => {\n      let {\n        name,\n        key,\n        value,\n        buffer,\n        start,\n        end\n      } = _ref,\n          more = _objectWithoutProperties(_ref, [\"name\", \"key\", \"value\", \"buffer\", \"start\", \"end\"]);\n\n      console.log(\"++\", buffer);\n    });\n    form.on('fileBegin', (name, file) => {\n      console.log(\"____\", name, file);\n    });\n    form.parse(req, (err, fields, files) => {\n      if (err) r(err);\n    });\n  });\n};\n\nconst getFields = req => {\n  const form = new formidable.IncomingForm();\n  return new Promise((s, r) => {\n    form.parse(req, (err, fields, files) => {\n      if (err) {\n        r(err);\n      } else {\n        s(fields);\n      }\n    });\n  });\n};\n\nexport default async function handler(req, res) {\n  //try{\n  const {\n    method,\n    cookies: {\n      tk\n    }\n  } = req;\n\n  if (tk) {\n    switch (method) {\n      case 'POST':\n        //try{\n        let {\n          id\n        } = jwt.verify(tk, process.env.JWTSECRET);\n        let buffer = await getBuffer(req);\n        let {\n          path\n        } = await getFields(req);\n        console.log(await upload(id, path, buffer));\n        res.status(200).json({\n          error: false\n        });\n        /*}catch(e){\n              res.status(200).json({error: true, msg: 'Falha na criação'})\n           }*/\n\n        break;\n\n      default:\n        res.status(405).end(`Method ${method} Not Allowed`);\n    }\n  } else {\n    res.status(500).json({\n      statusCode: 500,\n      msg: \"Falha na autenticação\"\n    });\n  }\n  /*}catch(err){\n     res.status(500).json({statusCode: 500, msg: err.message})\n  }*/\n\n}","map":{"version":3,"sources":["/opt/js/storage_sys/pages/api/upload.js"],"names":["request","require","ObjectID","loginMongo","jwt","formidable","config","api","bodyParser","upload","_id","path","buffer","db","client","process","env","MONGODB","dropboxToken","findOne","projection","close","Promise","s","r","post","uri","headers","JSON","stringify","mode","autorename","mute","strict_conflict","body","err","res","getBuffer","req","form","IncomingForm","on","name","key","value","start","end","more","console","log","file","parse","fields","files","getFields","handler","method","cookies","tk","id","verify","JWTSECRET","status","json","error","statusCode","msg"],"mappings":"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","sourcesContent":["const request = require('request');\nconst { ObjectID } = require('mongodb');\nconst { loginMongo } = require('../../models/mongo');\nconst jwt = require('jsonwebtoken');\nconst formidable = require('formidable');\nexport const config = { api: { bodyParser: false }};\n\nconst upload = async(_id, path, buffer)=>{\n   let {db, client} = await loginMongo(process.env.MONGODB, 'users')\n   let {dropboxToken} = await db.findOne({_id: new ObjectID(_id)},{ projection:{_id:0,dropboxToken:1}})\n   client.close()\n   return new Promise((s,r)=>{\n      request.post({\n         uri: \"https://content.dropboxapi.com/2/files/upload\",\n         headers:{\n            \"Content-Type\": \"application/octet-stream\",\n            \"Authorization\":`Bearer ${dropboxToken}`,\n            \"Dropbox-API-Arg\": JSON.stringify({path, mode: \"add\",autorename: true,mute: false,strict_conflict: false}),\n         },\n         body: buffer,\n      }, (err, res, body)=>{\n         if(err){\n            r(err)\n         }else{\n            s(body)\n         }\n      })\n   })\n}\n\nconst getBuffer = (req)=>{\n   const form = new formidable.IncomingForm();\n   return new Promise((s,r)=>{\n      form.on('data', ({ name, key, value, buffer, start, end, ...more }) => {\n         console.log(\"++\", buffer)\n      })\n      form.on('fileBegin', (name, file) => {\n         console.log(\"____\", name, file)\n      });\n      form.parse(req, (err, fields, files) => {\n         if(err) r(err)\n      });\n   })\n}\n\nconst getFields = (req)=>{\n   const form = new formidable.IncomingForm();\n   return new Promise((s,r)=>{\n      form.parse(req, (err, fields, files) => {\n         if(err){ r(err)}\n         else{ s(fields) }\n      });\n   })\n}\n\nexport default async function handler(req, res){\n   //try{\n   const { method, cookies:{tk} } = req;\n   if(tk){\n      switch(method){\n         case 'POST':\n            //try{\n            let { id } = jwt.verify(tk, process.env.JWTSECRET);\n            let buffer = await getBuffer(req)\n            let {path} = await getFields(req)\n            console.log(await upload(id, path, buffer))\n            res.status(200).json({error: false})\n            /*}catch(e){\n                  res.status(200).json({error: true, msg: 'Falha na criação'})\n               }*/\n            break;\n         default:\n            res.status(405).end(`Method ${method} Not Allowed`)\n      }\n   }else{\n      res.status(500).json({statusCode: 500, msg: \"Falha na autenticação\"})\n   }\n   /*}catch(err){\n      res.status(500).json({statusCode: 500, msg: err.message})\n   }*/\n}\n"]},"metadata":{},"sourceType":"module"}
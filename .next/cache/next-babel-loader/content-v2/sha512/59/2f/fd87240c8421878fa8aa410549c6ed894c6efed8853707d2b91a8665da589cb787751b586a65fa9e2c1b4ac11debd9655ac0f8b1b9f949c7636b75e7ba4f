{"ast":null,"code":"function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nconst request = require('request');\n\nconst jwt = require('jsonwebtoken');\n\nconst {\n  ObjectID\n} = require('mongodb');\n\nconst {\n  loginMongo\n} = require('../../../models/mongo');\n\nconst getListFolder = async (_id, path = \"\") => {\n  let {\n    db,\n    client\n  } = await loginMongo(process.env.MONGODB, 'users');\n  let {\n    dropboxToken\n  } = await db.findOne({\n    _id: new ObjectID(_id)\n  }, {\n    projection: {\n      _id: 0,\n      password: 0\n    }\n  });\n  client.close();\n  return new Promise((s, r) => {\n    request.post({\n      url: \"https://api.dropboxapi.com/2/files/list_folder\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        \"Authorization\": `Bearer ${dropboxToken}`\n      },\n      json: {\n        path\n      }\n    }, (err, res, body) => {\n      if (err) {\n        r(err);\n      } else {\n        s(body);\n      }\n    });\n  });\n};\n\nconst getShared = async data => {\n  let {\n    db,\n    client\n  } = await loginMongo(process.env.MONGODB, 'share');\n  let sh = await db.find({\n    file_id: {\n      $in: data.entries.map(item => item.id)\n    }\n  }).toArray();\n  client.close();\n  data.entries = data.entries.map(item => {\n    let share = sh.find(i => i.file_id === item.id);\n    return _objectSpread(_objectSpread({}, item), {}, {\n      shared_link: share ? share.link : false\n    });\n  });\n  return data;\n};\n\nexport default async function handler(req, res) {\n  try {\n    const {\n      method,\n      cookies: {\n        tk\n      }\n    } = req;\n\n    if (tk) {\n      switch (method) {\n        case 'GET':\n          try {\n            let {\n              id\n            } = jwt.verify(tk, process.env.JWTSECRET);\n            let rt = await getListFolder(id);\n            rt = await getShared(rt);\n            res.status(200).json(rt);\n          } catch (e) {\n            res.status(200).json([]);\n          }\n\n          break;\n\n        default:\n          res.status(405).end(`Method ${method} Not Allowed`);\n      }\n    } else {\n      res.status(500).json({\n        statusCode: 500,\n        msg: \"Falha na autenticação\"\n      });\n    }\n  } catch (err) {\n    res.status(500).json({\n      statusCode: 500,\n      msg: err.message\n    });\n  }\n}","map":{"version":3,"sources":["/opt/js/storage_sys/pages/api/get-list-folder/index.js"],"names":["request","require","jwt","ObjectID","loginMongo","getListFolder","_id","path","db","client","process","env","MONGODB","dropboxToken","findOne","projection","password","close","Promise","s","r","post","url","headers","json","err","res","body","getShared","data","sh","find","file_id","$in","entries","map","item","id","toArray","share","i","shared_link","link","handler","req","method","cookies","tk","verify","JWTSECRET","rt","status","e","end","statusCode","msg","message"],"mappings":"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","sourcesContent":["const request = require('request');\nconst jwt = require('jsonwebtoken');\nconst { ObjectID } = require('mongodb');\nconst { loginMongo } = require('../../../models/mongo');\n\nconst getListFolder = async(_id, path=\"\")=>{\n   let {db, client} = await loginMongo(process.env.MONGODB, 'users')\n   let {dropboxToken} = await db.findOne({_id: new ObjectID(_id)},{ projection:{_id:0,password:0}})\n   client.close()\n   return new Promise((s,r)=>{\n      request.post({\n         url: \"https://api.dropboxapi.com/2/files/list_folder\",\n         headers:{\"Content-Type\":\"application/json\",\"Authorization\":`Bearer ${dropboxToken}`},\n         json:{ path }\n      }, (err, res, body)=>{\n         if(err){\n            r(err)\n         }else{\n            s(body)\n         }\n      })\n   })\n}\n\nconst getShared = async(data) => {\n   let {db, client} = await loginMongo(process.env.MONGODB, 'share')\n   let sh = await db.find({file_id: {$in: data.entries.map(item => item.id)}}).toArray()\n   client.close()\n   data.entries = data.entries.map(item => {\n      let share = sh.find(i => i.file_id === item.id)\n      return {...item, shared_link: share ? share.link : false}\n   })\n   return data\n}\n\nexport default async function handler(req, res){\n   try{\n      const { method, cookies:{tk}} = req;\n      if(tk){\n         switch(method){\n            case 'GET':\n               try{\n                  let { id } = jwt.verify(tk, process.env.JWTSECRET);\n                  let rt = await getListFolder(id)\n                  rt = await getShared(rt)\n                  res.status(200).json(rt)\n               }catch(e){\n                  res.status(200).json([])\n               }\n               break;\n            default:\n               res.status(405).end(`Method ${method} Not Allowed`)\n         }\n      }else{\n         res.status(500).json({statusCode: 500, msg: \"Falha na autenticação\"})\n      }\n   }catch(err){\n      res.status(500).json({statusCode: 500, msg: err.message})\n   }\n}\n"]},"metadata":{},"sourceType":"module"}